<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>RVI + ROI Viewer</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- georaster -->
<script src="https://unpkg.com/georaster/dist/georaster.browser.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.min.js"></script>

<style>
  html, body { margin:0; height:100%; }
  #map { width:100%; height:100%; }
</style>
</head>
<body>

<div id="map"></div>

<script>
/*********************************************************
   1. MAP INITIALIZATION
**********************************************************/
const map = L.map("map", {
  center: [10.49, -85.50],
  zoom: 11
});

const satellite = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Esri Satellite" }
).addTo(map);

let rviLayer = null;
let roiLayer = null;

const layerControl = L.control.layers(
  { "Satellite": satellite },
  {},
  { collapsed: false, position: "topright" }
).addTo(map);


/*********************************************************
   2. ROI (BOUNDARY POLYGON)
**********************************************************/
const roiCoords = [
  [10.543880176744038, -85.59765362456451],
  [10.419983389530952, -85.59765362456451],
  [10.419983389530952, -85.40676617339264],
  [10.543880176744038, -85.40676617339264]
];

roiLayer = L.polygon(roiCoords, {
  color: "red",
  weight: 2,
  fillOpacity: 0.1
}).addTo(map);

layerControl.addOverlay(roiLayer, "ROI");


/*********************************************************
   3. LOAD THE RVI TIFF FROM GITHUB PAGES
**********************************************************/
const rviUrl = "https://palfangulo.github.io/WebGISMapping/maps/RVI/Mean_RVI_2025_20m.tif";

fetch(rviUrl)
  .then(response => response.arrayBuffer())
  .then(arrayBuffer => georaster(arrayBuffer))
  .then(georasterObj => {

    // RVI is between 0 and 1
    const rviMin = 0;
    const rviMax = 1;

    rviLayer = new GeoRasterLayer({
      georaster: georasterObj,
      opacity: 0.85,
      pixelValuesToColorFn: (value) => {
        
        if (value === null) return null;

        const v = (value - rviMin) / (rviMax - rviMin);
        const colorScale = [
          [0,   "blue"],
          [0.5, "green"],
          [1,   "yellow"]
        ];

        if (v <= 0) return "blue";
        if (v >= 1) return "yellow";
        if (v < 0.5) return "blue";
        if (v === 0.5) return "green";
        return "yellow";
      }
    });

    rviLayer.addTo(map);
    layerControl.addOverlay(rviLayer, "RVI");

    console.log("RVI TIFF loaded successfully");
  })
  .catch(err => console.error("Error loading TIFF:", err));

</script>

</body>
</html>
