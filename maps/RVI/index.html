<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>RVI + ROI Viewer</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GeoRaster -->
<script src="https://unpkg.com/georaster/dist/georaster.browser.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.min.js"></script>

<style>
  html, body { margin:0; height:100%; }
  #map { width:100%; height:100%; }
</style>
</head>
<body>

<div id="map"></div>

<script>
/*********************************************************
   1. MAP INITIALIZATION
**********************************************************/
const map = L.map("map", {
  center: [10.49, -85.50],
  zoom: 11
});

const satellite = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Esri Satellite" }
).addTo(map);

let rviLayer = null;
let roiLayer = null;

const layerControl = L.control.layers(
  { "Satellite": satellite },
  {},
  { collapsed: false, position: "topright" }
).addTo(map);


/*********************************************************
   2. ROI POLYGON (correct Leaflet lat/lng structure)
**********************************************************/
const roiCoords = [
  [10.543880176744038, -85.59765362456451],
  [10.419983389530952, -85.59765362456451],
  [10.419983389530952, -85.40676617339264],
  [10.543880176744038, -85.40676617339264]
];

roiLayer = L.polygon(roiCoords, {
  color: "red",
  weight: 2,
  fillOpacity: 0.1
}).addTo(map);

layerControl.addOverlay(roiLayer, "ROI");


/*********************************************************
   3. LOAD RVI TIFF FROM GITHUB PAGES
**********************************************************/
const rviUrl =
  "https://palfangulo.github.io/WebGISMapping/maps/RVI/Mean_RVI_2025_20m.tif";

fetch(rviUrl)
  .then(response => response.arrayBuffer())
  .then(arrayBuffer => georaster(arrayBuffer))
  .then(georasterObj => {

    console.log("GeoRaster loaded:", georasterObj);

    const rviMin = 0.15;    // adjust if needed
    const rviMax = 0.85;

    // Continuous color interpolation
    function interpolateColor(value) {
      if (value <= rviMin) return "blue";
      if (value >= rviMax) return "yellow";

      const t = (value - rviMin) / (rviMax - rviMin);

      // Blue → Green → Yellow gradient
      if (t < 0.5) {
        const f = t / 0.5;
        return `rgb(${0 * (1-f) + 0 * f}, ${0 * (1-f) + 255 * f}, 255)`; // blue→green
      } else {
        const f = (t - 0.5) / 0.5;
        return `rgb(${0 * (1-f) + 255 * f}, 255, 0)`; // green→yellow
      }
    }

    rviLayer = new GeoRasterLayer({
      georaster: georasterObj,
      opacity: 0.85,
      resolution: 128, // speed optimization
      pixelValuesToColorFn: (values) => {
        const v = values[0];
        if (v === null || isNaN(v)) return null;
        return interpolateColor(v);
      }
    });

    rviLayer.addTo(map);
    layerControl.addOverlay(rviLayer, "RVI");

    // Fit map to raster bounds
    map.fitBounds(rviLayer.getBounds());

    console.log("RVI TIFF loaded successfully");
  })
  .catch(err => console.error("TIFF load error:", err));
</script>

</body>
</html>
